library(devtools)
load_all()
library(tcrgrapher)
library(data.table)
library(edgeR)
# Let's find expanded clonotypes after vaccination. There are 8 mice and 5 time
# points: 2 points before vaccination and 3 after vaccination
# Data loading. See ?TCRgrapher
# One of the ways to read the data
file_path <- testthat::test_path("testdata/vaccinated_mice", "")
metadata_path <- testthat::test_path("testdata/metadata_vaccination.tsv")
TCRgrObject <- TCRgrapher(file_path, 1, 3, 4, 5, 7, metadata_path, 1, 2)
# see general information about the object
TCRgrObject
# see metadata
metadata(TCRgrObject)
# add column to metadata
metadata(TCRgrObject)$vaccination <- 'before'
# change some values
metadata(TCRgrObject)[metadata(TCRgrObject)$time > 2, 'vaccination'] <- 'after'
# create a count table with aggregation by V segments
TCRgrCounts <- TCRgrapherCounts(TCRgrObject)
# run EdgeR pipeline
# There are two comparison levels: before and after vaccination
edgeR_res <- edgeR_pipeline(TCRgrCounts, 'vaccination')
head(edgeR_res)
# To take a subset we should specify samples that we want to take
samples <-  metadata(TCRgrCounts)[time <= 3, 'sample_id']
TCRgrCounts_3 <- subset(TCRgrCounts, unlist(samples))
# check count table columns and metadata sample_id values
colnames(count_table(TCRgrCounts_3))
metadata(TCRgrCounts_3)$sample_id
# run edgeR pipeline
edgeR_res_3 <- edgeR_pipeline(TCRgrCounts_3, 'vaccination')
head(edgeR_res_3)
# create a count table with aggregation by V and J segments
TCRgrCounts_VJ <- TCRgrapherCounts(TCRgrObject, j_gene = TRUE)
# take the subset again
samples <-  metadata(TCRgrCounts_VJ)[time <= 3, 'sample_id']
TCRgrCounts_VJ_3 <- subset(TCRgrCounts_VJ, unlist(samples))
# run edgeR pipeline
edgeR_res_VJ_3 <- edgeR_pipeline(TCRgrCounts_VJ_3, 'vaccination')
head(edgeR_res_VJ_3)
# create a count table with aggregation by one amino acid sequence
TCRgrCounts_aa <- TCRgrapherCounts(TCRgrObject, v_gene = FALSE, j_gene = FALSE)
# take the subset again
samples <-  metadata(TCRgrCounts_aa)[time <= 3, 'sample_id']
TCRgrCounts_aa_3 <- subset(TCRgrCounts_aa, unlist(samples))
# run edgeR pipeline
edgeR_res_aa_3 <- edgeR_pipeline(TCRgrCounts_aa_3, 'vaccination')
head(edgeR_res_aa_3)
# create a count table by clusters
TCRgrCounts <- TCRgrapherCounts(TCRgrObject, cluster_id = TRUE)
library(igraph)
TCRgrCounts_clusters <- TCRgrapherCounts(TCRgrObject_3, cluster_id = TRUE)
library(dev)
library(devtools)
load_all
load_all
load_all()
library(tcrgrapher)
library(data.table)
library(edgeR)
file_path <- testthat::test_path("testdata/vaccinated_mice", "")
metadata_path <- testthat::test_path("testdata/metadata_vaccination.tsv")
TCRgrObject <- TCRgrapher(file_path, 1, 3, 4, 5, 7, metadata_path, 1, 2)
samples <-  metadata(TCRgrObject)[time <= 1, 'sample_id']
TCRgrObject_3 <- subset(TCRgrObject, unlist(samples))
TCRgrCounts_clusters <- TCRgrapherCounts(TCRgrObject_3, cluster_id = TRUE)
?matrix
matrix(0, 2, 2)
matrix(Inf, 2, 2)
?Inf
is.infinite(Inf)
ex1 <- matrix(Inf, 10, 10)
e
ex1
colnames(ex1, 1:10)
colnames(ex1, paste0(name, 1:10))
colnames(ex1, paste0('name', 1:10))
colnames(ex1) <- paste0('name', 1:10)
ex1
rownames(ex1) <- paste0('name', 1:10)
ex1
ex2 <- matrix(0, 2, 2)
rownames(ex2) <- c('name2', 'name8')
colnames(ex2) <- c('name2', 'name8')
ex2 <- matrix(0, 2, 2)
colnames(ex2) <- c('name2', 'name8')
rownames(ex2) <- c('name2', 'name8')
ex2
adj_matrix <- matrix(Inf, 800000, 800000)
adj_matrix <- matrix(Inf, 80000, 80000)
outer(clonoset$bestVGene, clonoset$bestVGene, FUN = '!=')
?graph_from_adjacency_matrix
?make_graph
# if(v_gene){
#   adj_matrix[outer(clonoset$bestVGene, clonoset$bestVGene, FUN = '!=')] <- 0
# }
# if(j_gene){
#   adj_matrix[outer(clonoset$bestJGene, clonoset$bestJGene, FUN = '!=')] <- 0
# }
# g <- graph_from_adjacency_matrix(
#   adj_matrix,
#   mode = "undirected"
# )
g <- make_empty_graph(directed = FALSE)
g <- add_edges(g, edges = c(1,35, 1,36, 34,37))
g <- add_vertices(g, c(1,35,36,37))
g <- add_edges(g, edges = c(1,35, 1,36, 34,37))
?add_edges
View(g)
View(g)
g <- add_edges(g, edges = c(1,35, 1,36, 34,37))
library(igraph)
# if(v_gene){
#   adj_matrix[outer(clonoset$bestVGene, clonoset$bestVGene, FUN = '!=')] <- 0
# }
# if(j_gene){
#   adj_matrix[outer(clonoset$bestJGene, clonoset$bestJGene, FUN = '!=')] <- 0
# }
# g <- graph_from_adjacency_matrix(
#   adj_matrix,
#   mode = "undirected"
# )
g <- make_empty_graph(directed = FALSE)
g <- add_edges(g, edges = c(1,35, 1,36, 34,37))
g <- add_vertices(g, c(1,35,36,37))
g <- add_edges(g, edges = c(1,35, 1,36, 34,37))
g <- add_edges(g, edges = c(1,35, 35,1))
g <- add_vertices(g, 1,35,36,37)
?add_vertices
# if(v_gene){
#   adj_matrix[outer(clonoset$bestVGene, clonoset$bestVGene, FUN = '!=')] <- 0
# }
# if(j_gene){
#   adj_matrix[outer(clonoset$bestJGene, clonoset$bestJGene, FUN = '!=')] <- 0
# }
# g <- graph_from_adjacency_matrix(
#   adj_matrix,
#   mode = "undirected"
# )
g <- make_empty_graph(directed = FALSE)
g <- add_vertices(g, 1)
g <- add_vertices(g, 35)
# if(v_gene){
#   adj_matrix[outer(clonoset$bestVGene, clonoset$bestVGene, FUN = '!=')] <- 0
# }
# if(j_gene){
#   adj_matrix[outer(clonoset$bestJGene, clonoset$bestJGene, FUN = '!=')] <- 0
# }
# g <- graph_from_adjacency_matrix(
#   adj_matrix,
#   mode = "undirected"
# )
g <- make_empty_graph(directed = FALSE)
g <- add_vertices(g, 10)
g$names <- paste('name', 1:10)
g <- add_edges(g, edges = c(1,6, 1,5, 3,4))
plot(g)
c(0,0,0) + c(1,0,1)
library(data.table)
DT <- data.table(a = 1:4, b = c('s', 's', 'b', 'b'))
DT[b = 's']
DT[b == 's']
DT[c(TRUE, FALSE, TRUE. FALSE)]
DT[c(TRUE, FALSE, TRUE, FALSE)]
DT[c(TRUE, FALSE, TRUE, FALSE) & b == 's']
?stringdist
?sapplt
?sapply
make_TCR_graph <- function(clonoset, v_gene = TRUE, j_gene = FALSE){
if (!requireNamespace("igraph", quietly = TRUE)) {
stop(
"Package \"igraph\" must be installed to use this function.",
call. = FALSE
)
}
# graph from adjacency matrix
# adj_matrix <- stringdistmatrix(clonoset$cdr3aa, clonoset$cdr3aa, method = "hamming")
# adj_matrix <- 1*(adj_matrix <= 1)
# rownames(adj_matrix) <- clonoset$clone_id
# colnames(adj_matrix) <- clonoset$clone_id
# diag(adj_matrix) <- 0
# if(v_gene){
#   adj_matrix[outer(clonoset$bestVGene, clonoset$bestVGene, FUN = '!=')] <- 0
# }
# if(j_gene){
#   adj_matrix[outer(clonoset$bestJGene, clonoset$bestJGene, FUN = '!=')] <- 0
# }
# g <- graph_from_adjacency_matrix(
#   adj_matrix,
#   mode = "undirected"
# )
g <- make_empty_graph(directed = FALSE)
n <- nrow(clonoset)
g <- add_vertices(g, n)
to_check <- rep(TRUE, n)
for(v in 1:n){
if(to_check[v]){
to_check[v] <- FALSE
candidates <- clonoset[to_check & grouping, .(cdr3aa, clone_id)]
neighbors <- stringdistmatrix(candidates$cdr3aa, candidates$cdr3aa, method = "hamming") <= 1
sapply(unlist(candidates[neighbors, .(clone_id)]), function(x) add_edges(g, edges = c(v, x)))
}
}
g
}
library(tcrgrapher)
library(data.table)
library(edgeR)
library(devtools)
load_all()
file_path <- testthat::test_path("testdata/vaccinated_mice", "")
metadata_path <- testthat::test_path("testdata/metadata_vaccination.tsv")
TCRgrObject <- TCRgrapher(file_path, 1, 3, 4, 5, 7, metadata_path, 1, 2)
samples <-  metadata(TCRgrObject)[time <= 1, 'sample_id']
TCRgrObject_3 <- subset(TCRgrObject, unlist(samples))
TCRgrCounts_clusters <- TCRgrapherCounts(TCRgrObject_3, cluster_id = TRUE)
library(devtools)
load_all()
library(tcrgrapher)
library(data.table)
library(edgeR)
# One of the ways to read the data
file_path <- testthat::test_path("testdata/vaccinated_mice", "")
metadata_path <- testthat::test_path("testdata/metadata_vaccination.tsv")
TCRgrObject <- TCRgrapher(file_path, 1, 3, 4, 5, 7, metadata_path, 1, 2)
# create a count table by clusters
samples <-  metadata(TCRgrObject)[time <= 1, 'sample_id']
TCRgrObject_3 <- subset(TCRgrObject, unlist(samples))
TCRgrCounts_clusters <- TCRgrapherCounts(TCRgrObject_3, cluster_id = TRUE)
library(igraph)
TCRgrCounts_clusters <- TCRgrapherCounts(TCRgrObject_3, cluster_id = TRUE)
clonoset <- clonoset(TCRgrObject_3)
g <- make_empty_graph(directed = FALSE)
n <- nrow(clonoset)
g <- add_vertices(g, n)
to_check <- rep(TRUE, n)
load_all()
TCRgrCounts_clusters <- TCRgrapherCounts(TCRgrObject_3, cluster_id = TRUE)
V_current <- clonoset$bestVGene[v]
v = 1
V_current <- clonoset$bestVGene[v]
candidates <- clonoset[to_check & bestVGene == V_current, .(cdr3aa, clone_id)]
candidates
candidates$cdr3aa
neighbors <- stringdistmatrix(candidates$cdr3aa, candidates$cdr3aa, method = "hamming") <= 1
neighbors
neighbors <- stringdistmatrix(candidates$cdr3aa[v], candidates$cdr3aa, method = "hamming") <= 1
neighbors
candidates$cdr3aa[v]
candidates$cdr3aa
stringdistmatrix(candidates$cdr3aa[v], candidates$cdr3aa, method = "hamming")
head(stringdistmatrix(candidates$cdr3aa[v], candidates$cdr3aa, method = "hamming"))
stringdistmatrix(candidates$cdr3aa[v], candidates$cdr3aa, method = "hamming")[1,1]
stringdistmatrix(candidates$cdr3aa[v], candidates$cdr3aa, method = "hamming")[1,2]
stringdistmatrix(candidates$cdr3aa[v], candidates$cdr3aa, method = "hamming")[1,3]
neighbors <- stringdistmatrix(candidates$cdr3aa[v], candidates$cdr3aa, method = "hamming") <= 1
neighbors[1,1]
candidates$cdr3aa[v]
neighbors <- stringdistmatrix(clonoset$cdr3aa[v], candidates$cdr3aa, method = "hamming") <= 1
candidates[neighbors, .(clone_id)]
unlist(candidates[neighbors, .(clone_id)])
?data.table
candidates[neighbors, clone_id]
candidates
candidates[neighbors,]
neighbors
neighbors[1,]
candidates[neighbors[1,], clone_id]
sapply(candidates[neighbors[1,], clone_id], function(x) add_edges(g, edges = c(v, x)))
candidates[neighbors[1,], clone_id]
n
n <- nrow(clonoset)
clonose
clonoset
load_all()
library(tcrgrapher)
library(data.table)
library(edgeR)
# for finding connectivity components of the graph
library(igraph)
file_path <- testthat::test_path("testdata/vaccinated_mice", "")
metadata_path <- testthat::test_path("testdata/metadata_vaccination.tsv")
TCRgrObject <- TCRgrapher(file_path, 1, 3, 4, 5, 7, metadata_path, 1, 2)
# create a count table by clusters
samples <-  metadata(TCRgrObject)[time <= 1, 'sample_id']
TCRgrObject_3 <- subset(TCRgrObject, unlist(samples))
TCRgrCounts_clusters <- TCRgrapherCounts(TCRgrObject_3, cluster_id = TRUE)
clonoset
clonoset <- clonoset[1:1000,]
g <- make_TCR_graph(clonoset = )
g <- make_TCR_graph(clonoset)
clonoset
clonoset[,clone_id := 1:.N,]
g <- make_TCR_graph(clonoset)
clonoset
g <- make_TCR_graph(clonoset)
# if(v_gene){
#   adj_matrix[outer(clonoset$bestVGene, clonoset$bestVGene, FUN = '!=')] <- 0
# }
# if(j_gene){
#   adj_matrix[outer(clonoset$bestJGene, clonoset$bestJGene, FUN = '!=')] <- 0
# }
# g <- graph_from_adjacency_matrix(
#   adj_matrix,
#   mode = "undirected"
# )
g <- make_empty_graph(directed = FALSE)
n <- nrow(clonoset)
g <- add_vertices(g, n)
to_check <- rep(TRUE, n)
to_check[v] <- FALSE
V_current <- clonoset$bestVGene[v]
candidates <- clonoset[to_check & bestVGene == V_current, .(cdr3aa, clone_id)]
neighbors <- stringdistmatrix(clonoset$cdr3aa[v], candidates$cdr3aa, method = "hamming") <= 1
neighbors
candidates[neighbors[1,], clone_id]
sapply(candidates[neighbors[1,], clone_id], function(x) add_edges(g, edges = c(v, x)))
g
v = 10
V_current <- clonoset$bestVGene[v]
candidates <- clonoset[to_check & bestVGene == V_current, .(cdr3aa, clone_id)]
neighbors <- stringdistmatrix(clonoset$cdr3aa[v], candidates$cdr3aa, method = "hamming") <= 1
sapply(candidates[neighbors[1,], clone_id], function(x) add_edges(g, edges = c(v, x)))
load_all
load_all()
file_path <- testthat::test_path("testdata/vaccinated_mice", "")
metadata_path <- testthat::test_path("testdata/metadata_vaccination.tsv")
TCRgrObject <- TCRgrapher(file_path, 1, 3, 4, 5, 7, metadata_path, 1, 2)
samples <-  metadata(TCRgrObject)[time <= 1, 'sample_id']
TCRgrObject_3 <- subset(TCRgrObject, unlist(samples))
TCRgrCounts_clusters <- TCRgrapherCounts(TCRgrObject_3, cluster_id = TRUE)
View(clonoset)
g <- make_TCR_graph(clonoset)
g <- make_empty_graph(directed = FALSE)
n <- nrow(clonoset)
g <- add_vertices(g, n)
to_check <- rep(TRUE, n)
for(v in 1:n){
if(to_check[v]){
to_check[v] <- FALSE
if(v_gene){
V_current <- clonoset$bestVGene[v]
candidates <- clonoset[to_check & bestVGene == V_current, .(cdr3aa, clone_id)]
if(j_gene){
J_current <- clonoset$bestJGene[v]
candidates <- candidates[bestJGene == J_current]
}
} else {
candidates <- clonoset[to_check, .(cdr3aa, clone_id)]
}
neighbors <- stringdistmatrix(clonoset$cdr3aa[v], candidates$cdr3aa, method = "hamming") <= 1
sapply(candidates[neighbors[1,], clone_id], function(x) add_edges(g, edges = c(v, x)))
}
}
v_gene = TRUE
j_gene = FALSE
g <- make_empty_graph(directed = FALSE)
n <- nrow(clonoset)
g <- add_vertices(g, n)
to_check <- rep(TRUE, n)
for(v in 1:n){
if(to_check[v]){
to_check[v] <- FALSE
if(v_gene){
V_current <- clonoset$bestVGene[v]
candidates <- clonoset[to_check & bestVGene == V_current, .(cdr3aa, clone_id)]
if(j_gene){
J_current <- clonoset$bestJGene[v]
candidates <- candidates[bestJGene == J_current]
}
} else {
candidates <- clonoset[to_check, .(cdr3aa, clone_id)]
}
neighbors <- stringdistmatrix(clonoset$cdr3aa[v], candidates$cdr3aa, method = "hamming") <= 1
sapply(candidates[neighbors[1,], clone_id], function(x) add_edges(g, edges = c(v, x)))
}
}
neighbors
clonoset$cdr3aa[v]
andidates$cdr3aa
candidates$cdr3aa
to_check
V_current
clonoset[to_check & bestVGene == V_current, .(cdr3aa, clone_id)]
clonoset
nrow(neighbors)
nrow(candidates)
load_all()
g <- make_TCR_graph(clonoset)
find_TCR_components(clonoset, g)
components(g)
g
plot(g)
?IGRAPH
?igraph
g <- make_TCR_graph(clonoset)
g
print_all(g)
x
v
candidates
adj_matrix <- stringdistmatrix(clonoset$cdr3aa, clonoset$cdr3aa, method = "hamming")
View(adj_matrix)
adj_matrix <= 1
sum(adj_matrix <= 1)
load_all()
g <- make_TCR_graph(clonoset)
g
load_all()
g <- make_TCR_graph(clonoset)
g
load_all()
g <- make_TCR_graph(clonoset)
load_all()
g <- make_TCR_graph(clonoset)
clonoset
load_all()
g <- make_TCR_graph(clonoset)
plot(g)
vertex_attr(g)
g
?add.edges
load_all()
g <- make_TCR_graph(clonoset)
g
load_all()
g <- make_TCR_graph(clonoset)
g
load_all()
g <- make_TCR_graph(clonoset)
g
load_all()
g <- make_TCR_graph(clonoset)
g
library(tcrgrapher)
library(data.table)
library(edgeR)
# for finding connectivity components of the graph
library(igraph)
file_path <- testthat::test_path("testdata/vaccinated_mice", "")
metadata_path <- testthat::test_path("testdata/metadata_vaccination.tsv")
TCRgrObject <- TCRgrapher(file_path, 1, 3, 4, 5, 7, metadata_path, 1, 2)
samples <-  metadata(TCRgrObject)[time <= 1, 'sample_id']
TCRgrObject_3 <- subset(TCRgrObject, unlist(samples))
TCRgrCounts_clusters <- TCRgrapherCounts(TCRgrObject_3, cluster_id = TRUE)
?txtProgressBar
load_all()
load_all()
TCRgrCounts_clusters <- TCRgrapherCounts(TCRgrObject_3, cluster_id = TRUE)
clonoset <- clonoset(TCRgrObject)
clonoset <- clonoset[1:1000]
clonoset
g <- make_TCR_graph()
g <- make_TCR_graph(clonoset)
g <- make_TCR_graph(clonoset)
clonoset <- clonoset(TCRgrObject)
v <- 1
stringdistmatrix(clonoset$cdr3aa[v], candidates$cdr3aa, method = "hamming")
V_current <- clonoset$bestVGene[v]
candidates <- clonoset[to_check & bestVGene == V_current, .(cdr3aa, clone_id)]
to_check <- rep(TRUE, n)
candidates <- clonoset[to_check & bestVGene == V_current, .(cdr3aa, clone_id)]
n <- nrow(clonoset)
g <- add_vertices(g, 800000)
library(tcrgrapher)
library(data.table)
library(edgeR)
# for finding connectivity components of the graph
library(igraph)
file_path <- testthat::test_path("testdata/vaccinated_mice", "")
metadata_path <- testthat::test_path("testdata/metadata_vaccination.tsv")
TCRgrObject <- TCRgrapher(file_path, 1, 3, 4, 5, 7, metadata_path, 1, 2)
# create a count table by clusters
samples <-  metadata(TCRgrObject)[time <= 1, 'sample_id']
TCRgrObject_3 <- subset(TCRgrObject, unlist(samples))
TCRgrCounts_clusters <- TCRgrapherCounts(TCRgrObject_3, cluster_id = TRUE)
g <- make_TCR_graph(clonoset(TCRgrObject_3))
document()
load_all()
devtool::check()
devtools::check()
library(methods)
devtools::check()
devtools::check()
document()
devtools::check()
devtools::check()
devtools::check()
library(testthat)
?setTxtProgressBar
?test_path
devtools::check()
devtools::check()
devtools::check()
testthat::test_path()
testthat::test_path("testdata/clonosets_vdjtools_format.tsv")
pwd()
getwd()
find.package('tcrgrapher')
devtools::check()
?TCRgrapher
?TCRgrapher
devtools::check()
devtools::check()
document()
devtools::check()
devtools::check()
document()
devtools::check()
